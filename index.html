<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>📷 二維碼掃描及資料管理</title>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js" defer></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" defer></script>
  <style>
    :root {
      --green:#4CAF50;
      --green-2:#45a049;
      --bg:#f5f5f5;
      --ok:#e0ffe0;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background:var(--bg); padding:20px; line-height:1.45; touch-action: manipulation; }
    h2 { margin-top:0; }
    nav { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:14px; }
    nav button { padding:8px 16px; border:none; border-radius:8px; background:var(--green); color:white; cursor:pointer; }
    nav button:hover { background:var(--green-2); }

    .mode-toggle { display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 8px; }
    .mode-toggle button { padding:6px 12px; border-radius:8px; border:1px solid var(--green); background:white; cursor:pointer; }
    .mode-toggle button.active { background:#c8e6c9; }

    #reader, #readerQuery { width:100%; max-width:420px; margin:auto; }
    .manual-box {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
      width: 100%;
    }
    .manual-box input[type="text"] {
      flex: 1 1 auto;
      min-width: 0;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .manual-box button {
      flex: 0 0 auto;
      min-width: 84px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: var(--green);
      color: #fff;
      cursor: pointer;
    }

    #result, #latestRecord { background:var(--ok); margin-top:12px; padding:10px; border-radius:8px; white-space:pre-line; }
    .tag-button { margin:5px; padding:8px 16px; border-radius:6px; border:1px solid var(--green); background:white; cursor:pointer; }
    .tag-button.active { background:#c8e6c9; }
    .tag-panel { margin-top:10px; }

    #tableSection { margin-top:10px; }
    #dataList, #queryTable { width:100%; overflow:auto; }
    table.dataTable { width:100% !important; }

    @media (max-width: 768px) {
      body { padding:12px; }
      #reader, #readerQuery { max-width: 340px; }
    }
  </style>
</head>
<body>
  <h2>📸 二維碼掃描及資料管理</h2>
  <nav>
    <button onclick="switchMode('scan')">掃碼上傳</button>
    <button onclick="switchMode('query')">掃碼查詢</button>
    <button onclick="loadData('A4O-Tracking')">A4O資料</button>
    <button onclick="loadData('A4I-Tracking')">A4I資料</button>
    <button onclick="loadData('A4IO-Tracking')">A4IO資料</button>
  </nav>

  <!-- 掃碼上傳 -->
  <div id="scanSection">
    <div class="mode-toggle">
      <button id="btnScanManual" class="active" onclick="setScanInputMode('manual')">手動輸入</button>
      <button id="btnScanCamera" onclick="setScanInputMode('camera')">相機掃描</button>
    </div>

    <!-- 手動輸入區 -->
    <div id="scanManualBox" class="manual-box">
      <input type="text" id="scanManualInput" placeholder="輸入 QR 內容後按 Enter 或送出" />
      <button onclick="triggerManualScan()">送出</button>
    </div>

    <!-- 相機掃描容器 -->
    <div id="reader" style="display:none;"></div>

    <div id="tagButtons" style="margin-top:10px;">載入中，請稍候...</div>
    <div id="tagPanel" class="tag-panel">請先點選標籤以顯示選項</div>
    <div style="margin-top:8px;">
      <label>備註：</label>
      <input type="text" id="globalNote" placeholder="輸入備註" style="width:80%; max-width:680px; padding:6px; border-radius:8px; border:1px solid #ccc;">
    </div>
    <div id="result">掃描結果會顯示在這裡</div>
    <div id="latestRecord">上次紀錄會顯示在這裡</div>
    <div id="loadingText"></div>
  </div>

  <!-- 掃碼查詢 -->
  <div id="querySection" style="display:none;">
    <div class="mode-toggle">
      <button id="btnQueryManual" class="active" onclick="setQueryInputMode('manual')">手動輸入</button>
      <button id="btnQueryCamera" onclick="setQueryInputMode('camera')">相機掃描</button>
    </div>

    <div id="queryManualBox" class="manual-box">
      <input type="text" id="queryManualInput" placeholder="輸入 QR 內容後按 Enter 或查詢" />
      <button onclick="triggerManualQuery()">查詢</button>
    </div>

    <div id="readerQuery" style="display:none;"></div>

    <div id="queryTable">請輸入或掃碼後查詢</div>
    <div id="queryLoading"></div>
  </div>

  <div id="tableSection" style="display:none;">
    <h3 id="tableTitle">📄 資料列表</h3>
    <div id="dataList"></div>
  </div>

<script>
let lastScanned = "";
let currentMode = "scan";
const scriptUrl = "https://script.google.com/macros/s/AKfycbzNCf2XNdHws_yO3LsWBE9UULrL1VTgI0xNAcqiHRdggNrQxjTKpr7ljXsrjzFn1QAh/exec";

let tagData = {};
let selectedValues = {};
let activeTag = "";

let scanner = null;
let scannerQuery = null;
let scanInputMode = "manual";
let queryInputMode = "manual";

/* ---------- 手動輸入觸發（送出後清空 + 聚焦） ---------- */
function triggerManualScan() {
  const inp = document.getElementById('scanManualInput');
  const v = inp.value.trim();
  if (v) {
    onScanSuccess(v);
    inp.value = "";
    inp.focus();
  }
}
function triggerManualQuery() {
  const inp = document.getElementById('queryManualInput');
  const v = inp.value.trim();
  if (v) {
    onQueryScan(v);
    inp.value = "";
    inp.focus();
  }
}

/* 其餘程式碼（loadTags、toggleTag、onScanSuccess、onQueryScan、renderQueryTable、loadData、switchMode、setScanInputMode、setQueryInputMode、clearScanCamera、clearQueryCamera...）保持不變，跟我上一版提供的相同 */
</script>
</body>
</html>
