<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>ğŸ“· äºŒç¶­ç¢¼æƒæåŠè³‡æ–™ç®¡ç†</title>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js" defer></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" defer></script>
  <style>
    :root {
      --green:#4CAF50;
      --green-2:#45a049;
      --bg:#f5f5f5;
      --ok:#e0ffe0;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background:var(--bg); padding:20px; line-height:1.45; touch-action: manipulation; }
    h2 { margin-top:0; }
    nav { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:14px; }
    nav button { padding:8px 16px; border:none; border-radius:8px; background:var(--green); color:white; cursor:pointer; }
    nav button:hover { background:var(--green-2); }

    .mode-toggle { display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 8px; }
    .mode-toggle button { padding:6px 12px; border-radius:8px; border:1px solid var(--green); background:white; cursor:pointer; }
    .mode-toggle button.active { background:#c8e6c9; }

    #reader, #readerQuery { width:100%; max-width:420px; margin:auto; }
    .manual-box {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
      width: 100%;
    }
    .manual-box input[type="text"] {
      flex: 1 1 auto;
      min-width: 0;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .manual-box button {
      flex: 0 0 auto;
      min-width: 84px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: var(--green);
      color: #fff;
      cursor: pointer;
    }

    #result, #latestRecord { background:var(--ok); margin-top:12px; padding:10px; border-radius:8px; white-space:pre-line; }
    .tag-button { margin:5px; padding:8px 16px; border-radius:6px; border:1px solid var(--green); background:white; cursor:pointer; }
    .tag-button.active { background:#c8e6c9; }
    .tag-panel { margin-top:10px; }

    #tableSection { margin-top:10px; }
    #dataList, #queryTable { width:100%; overflow:auto; }
    table.dataTable { width:100% !important; }

    @media (max-width: 768px) {
      body { padding:12px; }
      #reader, #readerQuery { max-width: 340px; }
    }
  </style>
</head>
<body>
  <h2>ğŸ“¸ äºŒç¶­ç¢¼æƒæåŠè³‡æ–™ç®¡ç†</h2>
  <nav>
    <button onclick="switchMode('scan')">æƒç¢¼ä¸Šå‚³</button>
    <button onclick="switchMode('query')">æƒç¢¼æŸ¥è©¢</button>
    <button onclick="loadData('A4O-Tracking')">A4Oè³‡æ–™</button>
    <button onclick="loadData('A4I-Tracking')">A4Iè³‡æ–™</button>
    <button onclick="loadData('A4IO-Tracking')">A4IOè³‡æ–™</button>
  </nav>

  <!-- æƒç¢¼ä¸Šå‚³ -->
  <div id="scanSection">
    <div class="mode-toggle">
      <button id="btnScanManual" class="active" onclick="setScanInputMode('manual')">æ‰‹å‹•è¼¸å…¥</button>
      <button id="btnScanCamera" onclick="setScanInputMode('camera')">ç›¸æ©Ÿæƒæ</button>
    </div>

    <!-- æ‰‹å‹•è¼¸å…¥å€ -->
    <div id="scanManualBox" class="manual-box">
      <input type="text" id="scanManualInput" placeholder="è¼¸å…¥ QR å…§å®¹å¾ŒæŒ‰ Enter æˆ–é€å‡º" />
      <button onclick="triggerManualScan()">é€å‡º</button>
    </div>

    <!-- ç›¸æ©Ÿæƒæå®¹å™¨ -->
    <div id="reader" style="display:none;"></div>

    <div id="tagButtons" style="margin-top:10px;">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
    <div id="tagPanel" class="tag-panel">è«‹å…ˆé»é¸æ¨™ç±¤ä»¥é¡¯ç¤ºé¸é …</div>
    <div style="margin-top:8px;">
      <label>å‚™è¨»ï¼š</label>
      <input type="text" id="globalNote" placeholder="è¼¸å…¥å‚™è¨»" style="width:80%; max-width:680px; padding:6px; border-radius:8px; border:1px solid #ccc;">
    </div>
    <div id="result">æƒæçµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
    <div id="latestRecord">ä¸Šæ¬¡ç´€éŒ„æœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
    <div id="loadingText"></div>
  </div>

  <!-- æƒç¢¼æŸ¥è©¢ -->
  <div id="querySection" style="display:none;">
    <div class="mode-toggle">
      <button id="btnQueryManual" class="active" onclick="setQueryInputMode('manual')">æ‰‹å‹•è¼¸å…¥</button>
      <button id="btnQueryCamera" onclick="setQueryInputMode('camera')">ç›¸æ©Ÿæƒæ</button>
    </div>

    <div id="queryManualBox" class="manual-box">
      <input type="text" id="queryManualInput" placeholder="è¼¸å…¥ QR å…§å®¹å¾ŒæŒ‰ Enter æˆ–æŸ¥è©¢" />
      <button onclick="triggerManualQuery()">æŸ¥è©¢</button>
    </div>

    <div id="readerQuery" style="display:none;"></div>

    <div id="queryTable">è«‹è¼¸å…¥æˆ–æƒç¢¼å¾ŒæŸ¥è©¢</div>
    <div id="queryLoading"></div>
  </div>

  <div id="tableSection" style="display:none;">
    <h3 id="tableTitle">ğŸ“„ è³‡æ–™åˆ—è¡¨</h3>
    <div id="dataList"></div>
  </div>

<script>
let lastScanned = "";
let currentMode = "scan";
const scriptUrl = "https://script.google.com/macros/s/AKfycbzNCf2XNdHws_yO3LsWBE9UULrL1VTgI0xNAcqiHRdggNrQxjTKpr7ljXsrjzFn1QAh/exec";

let tagData = {};
let selectedValues = {};
let activeTag = "";

let scanner = null;
let scannerQuery = null;
let scanInputMode = "manual";
let queryInputMode = "manual";

/* ---------- æ‰‹å‹•è¼¸å…¥è§¸ç™¼ï¼ˆé€å‡ºå¾Œæ¸…ç©º + èšç„¦ï¼‰ ---------- */
function triggerManualScan() {
  const inp = document.getElementById('scanManualInput');
  const v = inp.value.trim();
  if (v) {
    onScanSuccess(v);
    inp.value = "";
    inp.focus();
  }
}
function triggerManualQuery() {
  const inp = document.getElementById('queryManualInput');
  const v = inp.value.trim();
  if (v) {
    onQueryScan(v);
    inp.value = "";
    inp.focus();
  }
}

/* å…¶é¤˜ç¨‹å¼ç¢¼ï¼ˆloadTagsã€toggleTagã€onScanSuccessã€onQueryScanã€renderQueryTableã€loadDataã€switchModeã€setScanInputModeã€setQueryInputModeã€clearScanCameraã€clearQueryCamera...ï¼‰ä¿æŒä¸è®Šï¼Œè·Ÿæˆ‘ä¸Šä¸€ç‰ˆæä¾›çš„ç›¸åŒ */
</script>
</body>
</html>
