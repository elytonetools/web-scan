<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“· äºŒç¶­ç¢¼æƒæåŠè³‡æ–™ç®¡ç†ï¼ˆæ”¹è‰¯ç‰ˆï¼‰</title>
  <!-- 3rd-party libs -->
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js" defer></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" defer></script>
  <style>
    :root {
      --brand:#4CAF50; --brand-dark:#45a049; --bg:#f5f5f5; --ok:#e0ffe0; --warn:#fff4e5; --error:#ffe5e5;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background:var(--bg); padding:20px; }
    nav { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
    nav button { padding:8px 14px; border:none; border-radius:8px; background:var(--brand); color:#fff; cursor:pointer; }
    nav button:hover { background:var(--brand-dark); }
    .wrap { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 960px) { .wrap { grid-template-columns: 380px 1fr; } }
    #reader, #readerQuery { max-width:350px; margin:auto; }
    #result, #latestRecord { background:var(--ok); margin-top:12px; padding:10px; border-radius:10px; white-space:pre-line; }
    #loadingText, #queryLoading { margin-top:8px; font-size:14px; }
    .tag-button { margin:5px; padding:8px 14px; border-radius:8px; border:1px solid var(--brand); background:#fff; cursor:pointer; }
    .tag-button.active { background:#c8e6c9; }
    .tag-panel { margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .note-box { display:flex; gap:8px; align-items:center; }
    input[type="text"], input[type="number"], select { padding:8px; border-radius:8px; border:1px solid #ccc; }
    .pill { display:inline-flex; align-items:center; gap:6px; background:#fff; border:1px dashed #bbb; padding:6px 10px; border-radius:999px; font-size:12px; }
    .pill button { border:none; background:transparent; cursor:pointer; font-size:14px; }
    .panel { background:#fff; border-radius:12px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .tips { background:var(--warn); padding:10px; border-radius:10px; font-size:13px; }
    .error { background:var(--error); padding:10px; border-radius:10px; }
    .manual-box input{ padding:8px; border-radius:8px; border:1px solid #ccc; }
  .manual-box button{ padding:8px 14px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; }
  .manual-box button:hover{ background:#f0f0f0; }
</style>
</head>
<body>
  <h2>ğŸ“¸ äºŒç¶­ç¢¼æƒæåŠè³‡æ–™ç®¡ç†</h2>
  <nav>
    <button id="btn-scan">æƒç¢¼ä¸Šå‚³</button>
    <button id="btn-query">æƒç¢¼æŸ¥è©¢</button>
    <button onclick="loadData('A4O-Tracking')">A4Oè³‡æ–™</button>
    <button onclick="loadData('A4I-Tracking')">A4Iè³‡æ–™</button>
    <button onclick="loadData('A4IO-Tracking')">A4IOè³‡æ–™</button>
  </nav>

  <div class="wrap">
    <div id="leftCol">
      <div id="scanSection" class="panel">
        <div class="tips">è‹¥åœ¨æ‰‹æ©Ÿä¸Šä½¿ç”¨ï¼Œè«‹ä»¥ <b>HTTPS</b> ç¶²å€é–‹å•Ÿä»¥å•Ÿç”¨ç›¸æ©Ÿæ¬Šé™ï¼ˆiOS å¿…è¦ï¼‰ã€‚</div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
          <label for="cameraSelect">ç›¸æ©Ÿï¼š</label>
          <select id="cameraSelect"></select>
          <label class="pill"><input type="checkbox" id="torchToggle"> é–‹å•Ÿæ‰‹é›»ç­’ï¼ˆè‹¥æ”¯æ´ï¼‰</label>
        </div>
        <div id="reader"></div>
        <div class="manual-box" style="margin-top:10px; display:flex; gap:8px; align-items:center;">
          <input type="text" id="manualInput" placeholder="æ‰‹å‹•è¼¸å…¥æˆ–è²¼ä¸Š QR å…§å®¹ï¼ŒæŒ‰ Enter é€å‡º" style="flex:1;">
          <button id="manualSubmit">é€å‡º</button>
        </div>
        <div id="tagButtons" style="margin-top:10px;">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
        <div id="tagPanel" class="tag-panel">è«‹å…ˆé»é¸æ¨™ç±¤ä»¥é¡¯ç¤ºé¸é …</div>
        <div class="note-box" style="margin-top:10px;">
          <label>å‚™è¨»ï¼š</label>
          <input type="text" id="globalNote" placeholder="è¼¸å…¥å‚™è¨»ï¼ˆæœƒèˆ‡æ¨™ç±¤ä¸€èµ·ä¸Šå‚³ï¼‰" style="flex:1;">
          <button id="clearNote" title="æ¸…ç©º">æ¸…ç©º</button>
        </div>
        <div id="selectedChips" style="margin-top:8px;"></div>
        <div id="result">æƒæçµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
        <div id="latestRecord">ä¸Šæ¬¡ç´€éŒ„æœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
        <div id="loadingText"></div>
      </div>

      <div id="querySection" class="panel" style="display:none;">
        <div id="readerQuery"></div>
        <div class="manual-box" style="margin-top:10px; display:flex; gap:8px; align-items:center;">
          <input type="text" id="manualQueryInput" placeholder="æ‰‹å‹•è¼¸å…¥æˆ–è²¼ä¸ŠæŸ¥è©¢å­—ä¸²ï¼ŒæŒ‰ Enter é€å‡º" style="flex:1;">
          <button id="manualQuerySubmit">æŸ¥è©¢</button>
        </div>
        <div id="queryTable" style="margin-top:10px;">è«‹æƒç¢¼å¾ŒæŸ¥è©¢</div>
        <div id="queryLoading"></div>
      </div>

      <div class="panel tips" style="margin-top:10px;">
        <b>å°æŠ€å·§ï¼š</b>é‡è¤‡æƒåŒä¸€ç¢¼æœƒè‡ªå‹•å¿½ç•¥ 3 ç§’ã€æŒ‰ <kbd>Ctrl</kbd>+<kbd>C</kbd> å¯è¤‡è£½çµæœï¼›è®Šæ›´æ¨™ç±¤å¾Œå†æƒç¢¼æœƒè‡ªå‹•æŠŠæ–°æ¨™ç±¤å€¼ä½µå…¥å‚™è¨»ã€‚
      </div>
    </div>

    <div id="tableSection" class="panel" style="display:none;">
      <h3 id="tableTitle">ğŸ“„ è³‡æ–™åˆ—è¡¨</h3>
      <div id="dataList"></div>
    </div>
  </div>

<script>
  // ===== Config =====
  const scriptUrl = "https://script.google.com/macros/s/AKfycbyN49RSqSW6T4hroGFgCd0l-ql0WPl8rAIwy3hLRCtR2kbytEcaT7V_Dqik05grx_J5/exec";

  // ===== State =====
  let lastScanned = "";            // é˜²æŠ–ï¼š3 ç§’å…§åŒç¢¼å¿½ç•¥
  let currentMode = "scan";        // ç•«é¢æ¨¡å¼
  let tagData = {};                // æ¨™ç±¤ -> é¸é …
  let selectedValues = {};         // æ¨™ç±¤ -> å·²é¸å€¼
  let activeTag = "";              // ç›®å‰è¢«é»é¸çš„æ¨™ç±¤
  let scanner, scannerQuery;       // Html5QrcodeScanner å¯¦ä¾‹
  let currentCameraId = null;      // ç•¶å‰ç›¸æ©Ÿè£ç½® ID
  let isTorchOn = false;           // æ‰‹é›»ç­’ç‹€æ…‹

  // ===== Helpers =====
  const $ = (sel) => document.querySelector(sel);
  function escapeHTML(s) {
    return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }
  function debounceSameCode(decodedText, ms = 3000) {
    if (decodedText === lastScanned) return true;
    lastScanned = decodedText;
    setTimeout(() => { lastScanned = ""; }, ms);
    return false;
  }
  function persistSelections() {
    try { localStorage.setItem('qr_selectedValues', JSON.stringify(selectedValues)); } catch {}
  }
  function restoreSelections() {
    try {
      const raw = localStorage.getItem('qr_selectedValues');
      if (raw) selectedValues = JSON.parse(raw) || {};
      const note = localStorage.getItem('qr_globalNote') || '';
      $('#globalNote').value = note;
    } catch {}
  }
  function showChips() {
    const host = $('#selectedChips');
    host.innerHTML = '';
    Object.entries(selectedValues).forEach(([k,v]) => {
      if (!v) return;
      const chip = document.createElement('span');
      chip.className = 'pill';
      chip.innerHTML = `${escapeHTML(k)}: ${escapeHTML(v)} <button aria-label="ç§»é™¤" title="ç§»é™¤" data-key="${escapeHTML(k)}">âœ•</button>`;
      host.appendChild(chip);
    });
  }
  function withTimeout(promise, ms = 15000) {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort('timeout'), ms);
    return Promise.race([
      promise(ctrl.signal).finally(() => clearTimeout(t)),
      new Promise((_,rej) => setTimeout(() => rej(new Error('ç¶²è·¯é€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦')), ms+50))
    ]);
  }

  // ===== Tags =====
  function loadTags() {
    fetch(`${scriptUrl}?action=ItemList`)
      .then(res => res.json())
      .then(result => {
        if (result.status === 'success' && Array.isArray(result.data)) {
          result.data.forEach(row => {
            const tag = row[0]?.trim();
            const options = row.slice(1).filter(cell => cell !== '' && cell != null);
            if (tag) tagData[tag] = options;
          });
          renderTagButtons();
        } else {
          console.error('ItemList æ ¼å¼éŒ¯èª¤', result);
          $('#tagButtons').innerText = 'âš ï¸ è³‡æ–™æ ¼å¼éŒ¯èª¤';
        }
      })
      .catch(err => {
        console.error('è®€å– ItemList å¤±æ•—', err);
        $('#tagButtons').innerText = 'âš ï¸ è®€å–å¤±æ•—ï¼Œè«‹é‡æ•´';
      });
  }
  function renderTagButtons() {
    const btnContainer = $('#tagButtons');
    btnContainer.innerHTML = '';
    Object.keys(tagData).forEach(tag => {
      const btn = document.createElement('button');
      btn.className = 'tag-button';
      btn.innerText = tag;
      btn.id = `btn-${tag}`;
      btn.addEventListener('click', () => toggleTag(tag));
      btnContainer.appendChild(btn);
    });
    showChips();
  }
  function toggleTag(tag) {
    activeTag = tag;
    // åˆ‡æ›é«˜äº®
    Object.keys(tagData).forEach(t => document.getElementById(`btn-${t}`)?.classList.remove('active'));
    document.getElementById(`btn-${tag}`)?.classList.add('active');

    const panel = $('#tagPanel');
    panel.innerHTML = '';
    if (!tagData[tag] || tagData[tag].length === 0) { panel.innerHTML = 'âš ï¸ æ²’æœ‰é¸é …'; return; }

    // POE -> æ•¸å€¼è¼¸å…¥ï¼Œå…¶é¤˜ -> ä¸‹æ‹‰
    let html = `<label style="min-width:60px;">${escapeHTML(tag)}ï¼š</label>`;
    if (tag === 'POE') {
      html += `<input type="number" id="input-${escapeHTML(tag)}" placeholder="è«‹è¼¸å…¥æ•¸å­—" step="any" min="0" style="max-width:200px;">`;
    } else {
      html += `<select id="select-${escapeHTML(tag)}"><option value="">è«‹é¸æ“‡</option>`;
      tagData[tag].forEach(opt => { html += `<option value="${escapeHTML(opt)}">${escapeHTML(opt)}</option>`; });
      html += `</select>`;
    }
    panel.innerHTML = html;

    if (tag === 'POE') {
      const input = document.getElementById(`input-${tag}`);
      input.value = selectedValues[tag] || '';
      input.oninput = (e) => { selectedValues[tag] = e.target.value; persistSelections(); showChips(); };
    } else {
      const select = document.getElementById(`select-${tag}`);
      if (selectedValues[tag]) select.value = selectedValues[tag];
      select.onchange = (e) => { selectedValues[tag] = e.target.value; persistSelections(); showChips(); };
    }
  }

  // ===== Scanner =====
  async function initCameras() {
    try {
      const devices = await Html5Qrcode.getCameras();
      const sel = $('#cameraSelect');
      sel.innerHTML = '';
      devices.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id; opt.textContent = d.label || `ç›¸æ©Ÿ ${d.id}`;
        sel.appendChild(opt);
      });
      // é‚è¼¯ï¼šé¦–é¸èƒŒé¢ç›¸æ©Ÿ
      const back = devices.find(d => /back|rear/i.test(d.label));
      currentCameraId = back?.id || devices[0]?.id || null;
      if (currentCameraId) sel.value = currentCameraId;
      sel.onchange = () => { currentCameraId = sel.value; restartScanner(); setTimeout(hideFileScanUIs,0); };
    } catch (e) {
      console.warn('è®€å–æ”å½±æ©Ÿæ¸…å–®å¤±æ•—ï¼š', e);
    }
  }
  function restartScanner() {
    try { scanner?.clear(); } catch {}
    scanner = new Html5QrcodeScanner('reader', {
      fps: 12,
      qrbox: { width: 260, height: 260 },
      rememberLastUsedCamera: true,
      aspectRatio: 1.0,
      supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
    }, false);
    scanner.render(onScanSuccess);
  }
  function restartQueryScanner() {
    try { scannerQuery?.clear(); } catch {}
    scannerQuery = new Html5QrcodeScanner('readerQuery', {
      fps: 12,
      qrbox: { width: 260, height: 260 },
      rememberLastUsedCamera: true,
      aspectRatio: 1.0,
      supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
    }, false);
    scannerQuery.render(onQueryScan);
  }

  // æ‰‹é›»ç­’ï¼ˆåƒ…éƒ¨åˆ†è£ç½®/ç€è¦½å™¨æ”¯æ´ï¼‰
  $('#torchToggle')?.addEventListener('change', async (e) => {
    isTorchOn = e.target.checked;
    try {
      const el = document.querySelector('#reader video');
      const track = el?.srcObject?.getVideoTracks?.()[0];
      if (!track) return;
      await track.applyConstraints({ advanced: [{ torch: isTorchOn }] });
    } catch (err) {
      console.warn('Torch not supported', err);
      e.target.checked = false;
    }
  });

  $1  function submitManual(mode){
    if(mode==='scan'){
      const v = (document.getElementById('manualInput')?.value||'').trim();
      if(!v) return; onScanSuccess(v);
    } else if(mode==='query'){
      const v = (document.getElementById('manualQueryInput')?.value||'').trim();
      if(!v) return; onQueryScan(v);
    }
  }

  async function onScanSuccessScanUIs() {
    try {
      document.querySelectorAll('#reader input[type=file], #readerQuery input[type=file]').forEach(el=> el.style.display='none');
      document.querySelectorAll('#reader button, #readerQuery button').forEach(btn => {
        const t = (btn.innerText||'').trim();
        if (/file|image|æª”æ¡ˆ|åœ–ç‰‡/i.test(t)) btn.style.display = 'none';
      });
    } catch {}
  }

  // ===== Upload / Query Flows =====
  async function onScanSuccess(decodedText) {
    if (debounceSameCode(decodedText)) return;
    $('#result').innerText = `ğŸ“¦ æƒææˆåŠŸï¼š${decodedText}`;
    $('#loadingText').innerText = 'â¬†ï¸ è®€å–æœ€æ–°è³‡æ–™ä¸­...';

    try {
      const res = await fetch(`${scriptUrl}?action=LatestDataFilter&filter=${encodeURIComponent(decodedText)}`);
      const json = await res.json();
      const previousNote = json?.data?.å‚™è¨» || '';
      const previousDate = json?.data?.æ—¥æœŸ || 'ç„¡';
      $('#latestRecord').innerText = `ğŸ“„ ä¸Šæ¬¡ç´€éŒ„ï¼š${previousDate}\nå‚™è¨»ï¼š${previousNote || 'ç„¡'}`;

      // å°‡ä¸Šæ¬¡çš„å‚™è¨»æ‹†å› key:value
      const previousTagValues = {};
      if (previousNote) {
        previousNote.split(',').forEach(pair => {
          const [k, v] = pair.split(':');
          if (k && v) previousTagValues[k.trim()] = v.trim();
        });
      }

      // åˆä½µæœ¬æ¬¡å·²é¸æ¨™ç±¤
      Object.keys(selectedValues).forEach(tag => {
        if (selectedValues[tag]) previousTagValues[tag] = selectedValues[tag];
      });

      const extraNote = $('#globalNote').value.trim();
      try { localStorage.setItem('qr_globalNote', extraNote); } catch {}

      const tagsPart = Object.entries(previousTagValues).map(([k,v]) => `${k}:${v}`).join(', ');
      const finalNote = tagsPart + (tagsPart && extraNote ? ', ' : '') + extraNote;

      $('#loadingText').innerText = 'â¬†ï¸ æ­£åœ¨ä¸Šå‚³...';
      const up = await fetch(`${scriptUrl}?action=WriteData&text=${encodeURIComponent(decodedText)}&note=${encodeURIComponent(finalNote)}`);
      const upText = await up.text();
      $('#loadingText').innerText = `âœ… ä¸Šå‚³æˆåŠŸï¼š${upText}`;
    } catch (err) {
      console.error(err);
      $('#loadingText').innerText = `âŒ ä¸Šå‚³å¤±æ•—ï¼š${err.message}`;
    }
  }

  async function onQueryScan(decodedText) {
    if (debounceSameCode(decodedText)) return;
    $('#queryLoading').innerText = 'ğŸ” æŸ¥è©¢ä¸­...';
    try {
      const res = await fetch(`${scriptUrl}?action=DataFilter&filter=${encodeURIComponent(decodedText)}`);
      const json = await res.json();
      if (!Array.isArray(json.data) || json.data.length === 0) {
        $('#queryTable').innerHTML = 'âš ï¸ æ²’æœ‰æ‰¾åˆ°æ­·å²ç´€éŒ„';
      } else {
        renderQueryTable(json.data);
      }
      $('#queryLoading').innerText = '';
    } catch (err) {
      console.error(err);
      $('#queryLoading').innerText = `âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}`;
    }
  }

  function renderQueryTable(data) {
    const targetDiv = document.getElementById('queryTable');
    if (!Array.isArray(data) || data.length === 0) {
      targetDiv.innerHTML = 'âš ï¸ æ²’æœ‰è³‡æ–™';
      return;
    }
    if ($.fn.DataTable.isDataTable('#queryDataTable')) {
      $('#queryDataTable').DataTable().destroy();
      $('#queryDataTable').empty();
    }
    let html = `<table id="queryDataTable" class="display"><thead><tr>`;
    data[0].forEach(th => html += `<th>${escapeHTML(th)}</th>`);
    html += '</tr></thead><tbody>';
    data.slice(1).reverse().forEach(row => {
      html += '<tr>';
      row.forEach(cell => html += `<td>${escapeHTML(cell)}</td>`);
      html += '</tr>';
    });
    html += '</tbody></table>';
    targetDiv.innerHTML = html;
    $('#queryDataTable').DataTable({
      pageLength: 10,
      language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json' }
    });
  }

  function loadData(action) {
    $('#scanSection').style.display = 'none';
    $('#querySection').style.display = 'none';
    $('#tableSection').style.display = 'block';
    $('#tableTitle').innerText = `ğŸ“„ ${action.replace('-Tracking','')} è³‡æ–™`;
    const dataList = document.getElementById('dataList');
    dataList.innerHTML = 'âŒ› è¼‰å…¥ä¸­...';
    fetch(`${scriptUrl}?action=${action}`)
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data.data) || data.data.length === 0) { dataList.innerHTML = 'âš ï¸ æ²’æœ‰è³‡æ–™'; return; }
        let html = `<table id="dataTable" class="display"><thead><tr>`;
        data.data[0].forEach(th => html += `<th>${escapeHTML(th)}</th>`);
        html += '</tr></thead><tbody>';
        data.data.slice(1).reverse().forEach(row => {
          html += '<tr>';
          row.forEach(cell => html += `<td>${escapeHTML(cell)}</td>`);
          html += '</tr>';
        });
        html += '</tbody></table>';
        dataList.innerHTML = html;
        $('#dataTable').DataTable({
          pageLength: 10,
          language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json' }
        });
      })
      .catch(err => dataList.innerHTML = `âŒ è®€å–å¤±æ•—ï¼š${escapeHTML(err.message)}`);
  }

  function switchMode(mode) {
    currentMode = mode;
    if (mode === 'scan') {
      $('#scanSection').style.display = 'block';
      $('#querySection').style.display = 'none';
      $('#tableSection').style.display = 'none';
      restartScanner();
      try { scannerQuery?.clear(); } catch {}
    } else if (mode === 'query') {
      $('#scanSection').style.display = 'none';
      $('#querySection').style.display = 'block';
      $('#tableSection').style.display = 'none';
      restartQueryScanner(); setTimeout(hideFileScanUIs,0);
      try { scanner?.clear(); } catch {}
    }
  }

  // ===== Events =====
  document.addEventListener('DOMContentLoaded', async () => {
    // ç¶å®šæ¨¡å¼åˆ‡æ›
    document.getElementById('btn-scan').addEventListener('click', () => switchMode('scan'));
    document.getElementById('btn-query').addEventListener('click', () => switchMode('query'));

    restoreSelections();
    loadTags();
    await initCameras();
    restartScanner();
    scannerQuery = new Html5QrcodeScanner('readerQuery', { fps: 12, qrbox: { width: 260, height: 260 } }, false);

    // å‚™è¨»äº‹ä»¶$1// æ‰‹å‹•è¼¸å…¥äº‹ä»¶ï¼ˆæƒç¢¼ä¸Šå‚³ï¼‰
    document.getElementById('manualSubmit').addEventListener('click', () => submitManual('scan'));
    document.getElementById('manualInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitManual('scan'); });
    // æ‰‹å‹•è¼¸å…¥äº‹ä»¶ï¼ˆæƒç¢¼æŸ¥è©¢ï¼‰
    document.getElementById('manualQuerySubmit').addEventListener('click', () => submitManual('query'));
    document.getElementById('manualQueryInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitManual('query'); });

    // åˆªé™¤ chip
    document.getElementById('selectedChips').addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON' && e.target.dataset.key) {
        delete selectedValues[e.target.dataset.key];
        persistSelections();
        showChips();
      }
    });
  });
</script>
</body>
</html>
